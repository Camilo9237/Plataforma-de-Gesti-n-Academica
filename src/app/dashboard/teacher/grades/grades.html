<a class="back" (click)="goBack()">← Volver al Dashboard</a>

<section class="grades-root">
  <header class="grades-header">
    <h2>Registro de Calificaciones</h2>
    <p class="hint">Ingresa y gestiona las notas de tus estudiantes</p>
  </header>

  <!-- Mensaje de error -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Selección de curso y periodo -->
  <div class="selection card">
    <div class="field">
      <label>Grupo</label>
      <select [(ngModel)]="cursoSeleccionado" (change)="onGrupoChange()" [disabled]="loading">
        <option [ngValue]="null">Seleccionar grupo</option>
        <option *ngFor="let g of grupos" [ngValue]="g">{{ g.name }}</option>
      </select>
    </div>
    <div class="field">
      <label>Periodo</label>
      <select [(ngModel)]="periodoSeleccionado" [disabled]="loading">
        <option *ngFor="let p of periodos" [ngValue]="p">Periodo {{ p }}</option>
      </select>
    </div>
    <div class="field">
      <label>Tipo de Evaluación</label>
      <select [(ngModel)]="tipoEvaluacionSeleccionado">
        <option *ngFor="let tipo of tiposEvaluacion" [value]="tipo">{{ tipo }}</option>
      </select>
    </div>
    <div class="field">
      <label>Peso (%)</label>
      <input type="number" [(ngModel)]="pesoEvaluacion" min="0" max="1" step="0.01" />
      <small>Valor entre 0 y 1 (ej: 0.33 = 33%)</small>
    </div>
  </div>

  <!-- Indicador de carga -->
  <div *ngIf="loading" class="loading-indicator">
    <div class="spinner"></div>
    <p>Cargando calificaciones...</p>
  </div>

  <!-- Tabla de estudiantes -->
  <section class="students card" *ngIf="!loading && cursoSeleccionado">
    <div class="students-title">Lista de Estudiantes - {{ cursoSeleccionado.name }}</div>
    <div class="students-sub">Periodo {{ periodoSeleccionado }}</div>

    <table class="table" *ngIf="estudiantes.length > 0">
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>Nota 1</th>
          <th>Nota 2</th>
          <th>Nota 3</th>
          <th>Promedio</th>
          <th>Observaciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of estudiantes">
          <td class="code">{{ s.student_code }}</td>
          <td class="name">{{ s.student_name }}</td>
          <td><input type="number" [(ngModel)]="s.nota1" step="0.1" min="0" max="5" /></td>
          <td><input type="number" [(ngModel)]="s.nota2" step="0.1" min="0" max="5" /></td>
          <td><input type="number" [(ngModel)]="s.nota3" step="0.1" min="0" max="5" /></td>
          <td>
            <span class="chip" [class.pass]="s.average >= 3" [class.fail]="s.average < 3">
              {{ s.average || '—' }}
            </span>
          </td>
          <td><input [(ngModel)]="s.observaciones" placeholder="Observaciones..." /></td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="estudiantes.length === 0" class="empty-state">
      <p>No hay estudiantes matriculados en este curso</p>
    </div>

    <div class="actions-row" *ngIf="estudiantes.length > 0">
      <label class="auto">
        <input type="checkbox" (change)="calcularPromediosAuto()" /> 
        Calcular Promedio Automático
      </label>
      <div class="buttons">
        <button class="btn" (click)="calcularPromediosAuto()">
          Calcular Promedio
        </button>
        <button class="btn" (click)="exportarPDF()">
          Exportar PDF
        </button>
        <button 
          class="btn primary" 
          (click)="guardarCalificaciones()" 
          [disabled]="guardando">
          {{ guardando ? 'Guardando...' : 'Guardar Calificaciones' }}
        </button>
      </div>
    </div>
  </section>

  <!-- Mensaje cuando no hay curso seleccionado -->
  <section class="students card" *ngIf="!loading && !cursoSeleccionado">
    <div class="empty-state">
      <p>Por favor selecciona un grupo para ver las calificaciones</p>
    </div>
  </section>
</section>